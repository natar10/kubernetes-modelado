# =============================================================================
# API GATEWAY - Backend for Frontend (BFF)
# =============================================================================
# Punto de entrada centralizado para todos los microservicios
# - Recibe requests del Ingress
# - Hace proxy a los servicios internos
# - En producción: validaría JWT y añadiría headers X-User-ID, X-User-Roles
# Tipo de servicio: ClusterIP (expuesto vía Ingress)
# =============================================================================

---
# ConfigMap con configuración del API Gateway
apiVersion: v1
kind: ConfigMap
metadata:
  name: api-gateway-nginx-config
  namespace: eventos-system
  labels:
    app.kubernetes.io/component: gateway
    app.kubernetes.io/name: api-gateway
data:
  nginx.conf: |
    events {
        worker_connections 1024;
    }

    http {
        # Logging
        log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" -> $proxy_host';
        access_log /var/log/nginx/access.log main;

        # Upstream services
        upstream usuarios_service {
            server usuarios-service:8080;
        }

        upstream eventos_service {
            server eventos-service:8080;
        }

        upstream participacion_service {
            server participacion-service:8080;
        }

        upstream keycloak_service {
            server keycloak:8080;
        }

        server {
            listen 8080;
            server_name _;

            # ===========================================
            # HEALTH CHECKS
            # ===========================================
            location /health {
                return 200 '{"status": "healthy", "service": "api-gateway"}';
                add_header Content-Type application/json;
            }

            location /ready {
                return 200 '{"status": "ready", "service": "api-gateway"}';
                add_header Content-Type application/json;
            }

            # ===========================================
            # INFO ENDPOINT
            # ===========================================
            location = / {
                return 200 '{
                    "service": "api-gateway",
                    "version": "1.0.0-prototype",
                    "description": "Punto de entrada centralizado",
                    "routes": {
                        "/auth/*": "keycloak",
                        "/api/users/*": "usuarios-service",
                        "/api/eventos/*": "eventos-service (o participacion-service)",
                        "/api/participacion/*": "participacion-service"
                    },
                    "note": "En produccion: validaria JWT y añadiria headers X-User-ID, X-User-Roles"
                }';
                add_header Content-Type application/json;
            }

            # ===========================================
            # AUTENTICACIÓN -> Keycloak
            # ===========================================
            location /auth/ {
                proxy_pass http://keycloak_service/;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;

                # Headers de trazabilidad
                proxy_set_header X-Gateway-Request-Id $request_id;
            }

            # ===========================================
            # USUARIOS SERVICE
            # ===========================================
            location /api/users {
                # TODO: Aquí iría la validación JWT
                # auth_request /internal/validate-token;

                proxy_pass http://usuarios_service/api/users;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

                # Headers que el gateway añadiría tras validar JWT
                # proxy_set_header X-User-ID $user_id;
                # proxy_set_header X-User-Roles $user_roles;
                proxy_set_header X-Gateway-Request-Id $request_id;
            }

            # ===========================================
            # PARTICIPACIÓN SERVICE (rutas específicas primero)
            # ===========================================
            location ~ ^/api/eventos/([^/]+)/(unirse|abandonar|participantes)$ {
                proxy_pass http://participacion_service;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Gateway-Request-Id $request_id;
            }

            location /api/participacion {
                proxy_pass http://participacion_service/api/participacion;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Gateway-Request-Id $request_id;
            }

            # ===========================================
            # EVENTOS SERVICE (catch-all para /api/eventos)
            # ===========================================
            location /api/eventos {
                proxy_pass http://eventos_service/api/eventos;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Gateway-Request-Id $request_id;
            }

            # ===========================================
            # 404 para rutas no definidas
            # ===========================================
            location / {
                return 404 '{"error": "Not Found", "message": "Ruta no definida en el API Gateway"}';
                add_header Content-Type application/json;
            }
        }
    }

---
# Deployment del API Gateway
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-gateway
  namespace: eventos-system
  labels:
    app.kubernetes.io/component: gateway
    app.kubernetes.io/name: api-gateway
    app.kubernetes.io/part-of: eventos-platform
spec:
  replicas: 2
  selector:
    matchLabels:
      app: api-gateway
  template:
    metadata:
      labels:
        app: api-gateway
        app.kubernetes.io/component: gateway
        app.kubernetes.io/name: api-gateway
    spec:
      containers:
        - name: api-gateway
          image: nginx:1.25-alpine
          ports:
            - containerPort: 8080
              name: http
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "128Mi"
              cpu: "200m"
          volumeMounts:
            - name: nginx-config
              mountPath: /etc/nginx/nginx.conf
              subPath: nginx.conf
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 5
          readinessProbe:
            httpGet:
              path: /ready
              port: 8080
            initialDelaySeconds: 3
            periodSeconds: 5
            timeoutSeconds: 3
      volumes:
        - name: nginx-config
          configMap:
            name: api-gateway-nginx-config

---
# Service ClusterIP
apiVersion: v1
kind: Service
metadata:
  name: api-gateway
  namespace: eventos-system
  labels:
    app.kubernetes.io/component: gateway
    app.kubernetes.io/name: api-gateway
spec:
  type: ClusterIP
  ports:
    - port: 8080
      targetPort: 8080
      protocol: TCP
      name: http
  selector:
    app: api-gateway
